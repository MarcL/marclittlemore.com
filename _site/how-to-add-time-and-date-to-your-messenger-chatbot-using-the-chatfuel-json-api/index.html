<!DOCTYPE html>
<html lang="en" itemtype="http://schema.org/Article">

<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Technical articles from Marc Littlemore, a full-stack developer, and ex-videogames programmer, with over 26 years of development experience.">

    <title>Marc Littlemore</title>

    <link rel="canonical" href="https://www.marclittlemore.com/how-to-add-time-and-date-to-your-messenger-chatbot-using-the-chatfuel-json-api/">

    <link rel="stylesheet" href="https://unpkg.com/tachyons@4.7.0/css/tachyons.min.css"/>

    <!-- Custom CSS -->
    
    
    

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <script src="https://kit.fontawesome.com/d38990851e.js" crossorigin="anonymous"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/images/favicons/manifest.json">
<link rel="mask-icon" href="/images/favicons/safari-pinned-tab.svg" color="#5bbad5">
<meta name="theme-color" content="#ffffff">


    <meta name="p:domain_verify" content="7613bb2239e62b55de06dc926e1b6431"/>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-810717-3', 'auto');
  ga('send', 'pageview');
</script>
    








<!-- Open Graph -->
<meta property="og:site_name" content="Marc Littlemore" />
<meta property="og:url" content="https://www.marclittlemore.com/how-to-add-time-and-date-to-your-messenger-chatbot-using-the-chatfuel-json-api/" />
<meta property="og:title" content="" />
<meta property="og:description" content="" />

<meta property="og:image" content="https://www.marclittlemore.com/images/banners/home-bg.jpg" />
<meta property="og:type" content="article" />
<meta property="og:locale" content="en_GB" />
<meta property="article:published_time" content="2020-02-14" />
<meta property="article:author" content="https://www.facebook.com/marcdavidlittlemore" />

<!-- Schema.org markup for Google+ -->
<meta itemprop="name" content="">
<meta itemprop="description" content="">
<meta itemprop="image" content="https://www.marclittlemore.com/images/banners/home-bg.jpg">

<!-- Twitter Card data -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@marclittlemore">
<meta name="twitter:title" content="">
<meta name="twitter:description" content="">
<meta name="twitter:creator" content="@marclittlemore">
<!-- Twitter summary card with large image must be at least 280x150px -->
<meta name="twitter:image:src" content="https://www.marclittlemore.com/images/banners/home-bg.jpg">


    
    <script src="//load.sumome.com/" data-sumo-site-id="a260c264ca479174c95ace07722082ec75abbab6778c364ba7a24230cc55c451" async="async"></script>
    

    
        
    

    <!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window,document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '290377285027331'); 
fbq('track', 'PageView');
</script>
<noscript>
    <img height="1" width="1" 
src="https://www.facebook.com/tr?id=290377285027331&ev=PageView
&noscript=1"/>
</noscript>
<!-- End Facebook Pixel Code -->
</head>


<body class="avenir helvetica bg-white">

    <header class="white w-100 pt2 pb0 pb2-ns" style="z-index:100;">
    <nav class="fw6 ttu tracked tc">
        <div class="db" id="navLinks">
            
                
                    <a class="f7 f5-ns link dim black dib mr2 mr3-ns" href="/" title="marclittlemore.com">Home</a>
                
            
                
                    <a class="f7 f5-ns link dim black dib mr2 mr3-ns" href="/talks/" title="Ideas I've shared">Talks</a>
                
            
                
                    <a class="f7 f5-ns link dim black dib mr2 mr3-ns" href="/bots/" title="Learn how to create your own chatbot">Chatbots</a>
                
            
                
                    <a class="f7 f5-ns link dim black dib mr2 mr3-ns" href="/about/" title="Find out more about me">About</a>
                
            
        </div>
    </nav>
</header>


    <main id="main-content">
  <div class="mw8 center pt2 tc">
      <h1 class="f3 f1-ns black fw6 mt1 mb1 ph1 pv0">
        How to add time and date to your Messenger chatbot using the Chatfuel JSON API
      </h1>
      
        <h2 class="f3-ns f5 fw4 lh-copy gray mt1 mb2 ph1">Can your chatbot tell the time? Let's look at how we can make your chatbot aware of a user's time and date to improve your chatbot flows.</h2>
      
  </div>

  <div class="mw8 center pt2 tc">
    <img class="w-100 br2 shadow-4" src="/images/banners/time-and-date.jpg" title="How to add time and date to your Messenger chatbot using the Chatfuel JSON API - Can your chatbot tell the time? Let's look at how we can make your chatbot aware of a user's time and date to improve your chatbot flows." alt="How to add time and date to your Messenger chatbot using the Chatfuel JSON API - Can your chatbot tell the time? Let's look at how we can make your chatbot aware of a user's time and date to improve your chatbot flows." />
  </div>

  <section class="mw8 pa3 mw8-ns ph5-ns center">
    <div class="roboto lh-copy f4-ns f5">
      
<div class="i fw5">
    <p>üëâüèª Want to learn more about JSON? Want to learn about the magic of JSON without being a developer? Get my <a href="/bots/sign-up-bot-building-for-beginners/" title="FREE JSON guide">FREE JSON guide</a> and you'll have JSON skills in no time!</p>
</div>
<h2>Watch the video</h2>
<div class="aspect-ratio aspect-ratio--16x9 overflow-hidden mw-100">
    <iframe
        class="absolute top-0 left-0 w-100 h-100"
        src="https://www.youtube.com/embed/"
        frameborder="0"
        allowfullscreen>
    </iframe>
</div>
<p>One of the main benefits of creating a Facebook Messenger chatbot is that you don't have to be present to answer messages for 24 hours per day. Your chatbot should be on hand to do this while you're fast asleep. What would be even better is if it could understand where your user lives and give them relevant content for their time of day. It could let them know whether your shop is open for business. Or it could send your users the breakfast menu rather than the dinner menu because it knows it's 9am where they are. This functionality doesn't exist in Chatfuel by default so let me teach you how to build an API which adds time and date functions to your chatbot.</p>
<h2>Timezones &amp; Coordinated Universal Time</h2>
<p>When your users talk to you on Facebook Messenger, they may live anywhere around the world. This means we need to know what the time is where they live. Each user can potential live in a different <a href="https://en.wikipedia.org/wiki/Time_zone">time zone</a>. This means we may need to add or subtract a number of hours to the time where your server is to allow for this time difference. Although you might think that it's always a whole number of hours, there are time zones which have half hours too. But what time is it where your API server is hosted? Well, this depends on where the data centre is that is storing and executing your code. What happens if your server is in New York, which is 5 hours behind <a href="https://en.wikipedia.org/wiki/Greenwich_Mean_Time">Greenwich Mean Time</a> (GMT), but your user is Germany, which is 1 hour ahead of GMT. And what happens if <a href="https://en.wikipedia.org/wiki/Daylight_saving_time">daylight saving time</a> has happened in one of those countries? Calculating the time is hard and things can get even more complicated. That's why we have a time standard which everyone uses. It's called <a href="https://en.wikipedia.org/wiki/Coordinated_Universal_Time">Coordinated Universal Time</a> or UTC. The Wikipedia page will explain why it's not an acronym of CUT! Using UTC allows us to define all times as relative to this standard. If we store all of our times in UTC, life becomes a bit easier.</p>
<h2>Calculating a user's time</h2>
<p>I've set up an <a href="https://glitch.com/edit/#!/chatfuel-demo-bot?path=routes/timeDate.js:1:0">example Node.js Express server using Glitch</a> which exposes an API for all of my Chatfuel demos. The API for this article is available on the following endpoint:</p>
<p><a href="https://chatfuel-demo-bot.glitch.me/timedate">https://chatfuel-demo-bot.glitch.me/timedate</a></p>
<p>The first thing we need to do is to calculate the user's local time using UTC. JavaScript (and Node.js) has a global object called <code>Date</code> which expose a set of methods we can use to determine and manipulate the date and time. First, we need to determine the time right now. We can use the <code>Date.now()</code> function which will return us the UTC <a href="https://en.wikipedia.org/wiki/Unix_time">epoch time</a>. This is the number of milliseconds since the start of UNIX time (at 00:00 on January 1st, 1970). We can then use this to calculate how many milliseconds difference between the user's timezone and the time now. Using JavaScript's <code>Date</code> object, we can then inspect this and pull out the date and time to use in our chatbot. Let's look at some code to do this:</p>
<pre><code class="language-javascript">// Calculate the number of milliseconds in an hour
// - 1000 milliseconds in a second,
// - 60 seconds in a minute
// - 60 minutes in an hour
const ONE_HOUR_IN_MILLISECONDS = 60 * 60 * 1000;

// Pass in an offset in hours which we use to calculate the user's time
const getUserDateInTimezone = offsetInHours =&gt; {
    // Calculate the UNIX timestamp in UTC
    const utcDate = Date.now();
  
    // Get the user's offset in milliseconds
    // The offsetInHours could be a negative number if
    // the user's timezone is behind UTC
    const offsetInMilliseconds = ONE_HOUR_IN_MILLISECONDS * offsetInHours;
  
    // Create a new Date object which adds the time offset to the time now
    return new Date(utcDate + offsetInMilliseconds);
};
</code></pre>
<p>Once we've written a function to calculate a new <code>Date</code> object, we can use the built in functions to inspect the data and return it to our user. As we're using Express to expose an API, we'll use its routing methods to expose a HTTP GET endpoint which allows our Chatfuel chatbot to make a request using the JSON API. We will allow it to pass through a timezone as a query parameter which Facebook Messenger can provide us. We can then set some user attributes which are returned to Chatfuel and can be used in our chatbot flows. Let's look at how we can do this:</p>
<pre><code class="language-javascript">const express = require('express');
const router = express.Router();

// ... add the time calculation code from above here

router.get('/', (request, response) =&gt; {
    // Allow a query parameter called &quot;timezone&quot; to be passed with the GET request
    // Default it to zero if we don't send one
    const {timezone = 0} = request.query;

    // Calculate the user's current Date in UTC using our code from above
    const userDateInTimezone = getUserDateInTimezone(timezone);
  
    // Inspect the Date object and pull out the data we need
    // Build an object which we can return to Chatfuel
    const dateObject = {
        // Get the day
        day: userDateInTimezone.getDate(),
        
        // Note that month is zero-indexed (from 0 for January to 11 for December)
        // For it to make sense for an actual month number, add one to it!
        month: userDateInTimezone.getMonth() + 1,
        
        // Get the full 4-digit year e.g. 2020
        year: userDateInTimezone.getFullYear(),

        // Get the number of hours
        hours: userDateInTimezone.getHours(),

        // Get the number of minutes
        minutes: userDateInTimezone.getMinutes(),

        // Get the number of seconds
        seconds: userDateInTimezone.getSeconds(),

        // Get a standard ISO-8601 formatted string
        isoTime: userDateInTimezone.toISOString()
    };

    // Format the data so that Chatfuel can set user attributes
    const userAttributes = {
        set_attributes: dateObject
    };

    // Return a JSON response that Chatfuel can understand
    response.json(userAttributes);
});

// If we're putting our routes into separate modules for clarity
// then we need to export the routes for use in the Express application
module.exports = router;
</code></pre>
<p>The last thing you need to do is to use this code in your Chatfuel chatbot. You can use the redirect blocks to check the value of &quot;hours&quot; returned after calling your API. If they are greater than 18, or 6pm, you could consider it to be evening and change the user responses accordingly. In a similar way, you can check if the value is greater than 6, or 6am, and then consider it to be breakfast time. Once you've got the user's time and date, you can give timely responses to your user. Watch <a href="https://www.youtube.com/watch?v=UDrGpc4Dp8w">my video</a> for more examples.</p>
<p>All of the code is available on my <a href="https://glitch.com/~chatfuel-demo-bot">Chatfuel demo Glitch project</a>. Feel free to clone it and use it for your own APIs. If you spot any errors, or have any questions, then please <a href="/contact">send me a message</a>. I love to hear from people and I'm always happy to answer your questions.</p>
<div class="i fw5">
    <p>üëâüèª Want to learn more about JSON? Want to learn about the magic of JSON without being a developer? Get my <a href="/bots/sign-up-bot-building-for-beginners/" title="FREE JSON guide">FREE JSON guide</a> and you'll have JSON skills in no time!</p>
</div>


    </div>
  </section>
</main>


    <footer class="pv4 ph3 ph5-ns tc bg-light-gray bt b--moon-gray">
    <a href="/feed.xml" title="RSS feed" class="link dark-gray hover-silver dib h2 w2 mr3" aria-label="RSS feed icon">
        <span class="fa-stack fa-lg">
            <i class="fa fa-circle fa-stack-2x"></i>
            <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
        </span>
    </a>

    <a href="http://twitter.com/marclittlemore" target="_blank" rel="noreferrer" title="You should follow me on Twitter" class="link dark-gray hover-silver dib h2 w2 mr3" aria-label="Twitter icon">
        <span class="fa-stack fa-lg">
            <i class="fa fa-circle fa-stack-2x"></i>
            <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
        </span>
    </a>

    <a href="https://github.com/MarcL" target="_blank" rel="noreferrer" title="Follow me on GitHub" class="link dark-gray hover-silver dib h2 w2 mr3" aria-label="GitHub icon">
        <span class="fa-stack fa-lg">
            <i class="fa fa-circle fa-stack-2x"></i>
            <i class="fa fa-github fa-stack-1x fa-inverse"></i>
        </span>
    </a>

    <a href="https://www.instagram.com/marclittlemore" target="_blank" rel="noreferrer" title="Follow me on Instagram" class="link dark-gray hover-silver dib h2 w2 mr3" aria-label="Instagram icon">
        <span class="fa-stack fa-lg">
            <i class="fa fa-circle fa-stack-2x"></i>
            <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
        </span>
    </a>

    <a href="https://www.reddit.com/user/marclittlemore" target="_blank" rel="noreferrer" title="Upvote me on Reddit" class="link dark-gray hover-silver dib h2 w2 mr3" aria-label="Reddit icon">
        <span class="fa-stack fa-lg">
            <i class="fa fa-circle fa-stack-2x"></i>
            <i class="fa fa-reddit fa-stack-1x fa-inverse"></i>
        </span>
    </a>


  <div class="mt4 ttu">
    <a href="/javascript-testing" class="f6 fw5 link underline-hover near-black dib mr3 mr4-ns">JS Testing</a>
    <a href="/now" class="f6 fw5 link underline-hover near-black dib mr3 mr4-ns">Now</a>
    <a href="/uses" class="f6 fw5 link underline-hover near-black dib mr3 mr4-ns">Uses</a>
    <a href="/articles" class="f6 fw5 link underline-hover near-black dib mr3 mr4-ns">Articles</a>
    <a href="/contact" class="f6 fw5 link underline-hover near-black dib">Contact</a>
  </div>
  <div class="mt4 dark-gray f6 fw6 ttu">
      Copyright &copy; Marc Littlemore 
  </div>
</footer>

<script async defer data-pin-hover="true" data-pin-color="red" data-pin-tall="true" src="//assets.pinterest.com/js/pinit.js"></script>


</body>

</html>
