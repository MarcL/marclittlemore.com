<!DOCTYPE html>
<html lang="en" itemtype="http://schema.org/Article">

<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Technical articles from Marc Littlemore, a full-stack developer, and ex-videogames programmer, with over 26 years of development experience.">

    <title>Marc Littlemore</title>

    <link rel="canonical" href="https://www.marclittlemore.com/how-to-unit-test-express-routes/">

    <link rel="stylesheet" href="https://unpkg.com/tachyons@4.7.0/css/tachyons.min.css"/>

    <!-- Custom CSS -->
    
    
    

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <script src="https://kit.fontawesome.com/d38990851e.js" crossorigin="anonymous"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/images/favicons/manifest.json">
<link rel="mask-icon" href="/images/favicons/safari-pinned-tab.svg" color="#5bbad5">
<meta name="theme-color" content="#ffffff">


    <meta name="p:domain_verify" content="7613bb2239e62b55de06dc926e1b6431"/>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-810717-3', 'auto');
  ga('send', 'pageview');
</script>
    








<!-- Open Graph -->
<meta property="og:site_name" content="Marc Littlemore" />
<meta property="og:url" content="https://www.marclittlemore.com/how-to-unit-test-express-routes/" />
<meta property="og:title" content="" />
<meta property="og:description" content="" />

<meta property="og:image" content="https://www.marclittlemore.com/images/banners/home-bg.jpg" />
<meta property="og:type" content="article" />
<meta property="og:locale" content="en_GB" />
<meta property="article:published_time" content="2016-11-06" />
<meta property="article:author" content="https://www.facebook.com/marcdavidlittlemore" />

<!-- Schema.org markup for Google+ -->
<meta itemprop="name" content="">
<meta itemprop="description" content="">
<meta itemprop="image" content="https://www.marclittlemore.com/images/banners/home-bg.jpg">

<!-- Twitter Card data -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@marclittlemore">
<meta name="twitter:title" content="">
<meta name="twitter:description" content="">
<meta name="twitter:creator" content="@marclittlemore">
<!-- Twitter summary card with large image must be at least 280x150px -->
<meta name="twitter:image:src" content="https://www.marclittlemore.com/images/banners/home-bg.jpg">


    
    <script src="//load.sumome.com/" data-sumo-site-id="a260c264ca479174c95ace07722082ec75abbab6778c364ba7a24230cc55c451" async="async"></script>
    

    
        
    

    <!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window,document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '290377285027331'); 
fbq('track', 'PageView');
</script>
<noscript>
    <img height="1" width="1" 
src="https://www.facebook.com/tr?id=290377285027331&ev=PageView
&noscript=1"/>
</noscript>
<!-- End Facebook Pixel Code -->
</head>


<body class="avenir helvetica bg-white">

    <header class="white w-100 pt2 pb0 pb2-ns" style="z-index:100;">
    <nav class="fw6 ttu tracked tc">
        <div class="db" id="navLinks">
            
                
                    <a class="f7 f5-ns link dim black dib mr2 mr3-ns" href="/" title="marclittlemore.com">Home</a>
                
            
                
                    <a class="f7 f5-ns link dim black dib mr2 mr3-ns" href="/talks/" title="Ideas I've shared">Talks</a>
                
            
                
                    <a class="f7 f5-ns link dim black dib mr2 mr3-ns" href="/bots/" title="Learn how to create your own chatbot">Chatbots</a>
                
            
                
                    <a class="f7 f5-ns link dim black dib mr2 mr3-ns" href="/about/" title="Find out more about me">About</a>
                
            
        </div>
    </nav>
</header>


    <main id="main-content">
  <div class="mw8 center pt2 tc">
      <h1 class="f3 f1-ns black fw6 mt1 mb1 ph1 pv0">
        How To Unit Test Express Routes
      </h1>
      
        <h2 class="f3-ns f5 fw4 lh-copy gray mt1 mb2 ph1">Unit testing of Express routes is often tricky but it can be done. Here's how to do it and why you probably should.</h2>
      
  </div>

  <div class="mw8 center pt2 tc">
    <img class="w-100 br2 shadow-4" src="/images/banners/unit-testing-express-routes.jpg" title="How To Unit Test Express Routes - Unit testing of Express routes is often tricky but it can be done. Here's how to do it and why you probably should." alt="How To Unit Test Express Routes - Unit testing of Express routes is often tricky but it can be done. Here's how to do it and why you probably should." />
  </div>

  <section class="mw8 pa3 mw8-ns ph5-ns center">
    <div class="roboto lh-copy f4-ns f5">
      
<p>I was swiping through my Twitter timeline the other night when I saw a really interesting tweet from <a href="https://kentcdodds.com/">Kent C Dodds</a>, a great JavaScript developer who works at PayPal, and someone you should really follow on Twitter if you don't already. He asked the following question.</p>
<p>&lt;blockquote class=&quot;twitter-tweet&quot; data-lang=&quot;en&quot;&gt;&lt;p lang=&quot;en&quot; dir=&quot;ltr&quot;&gt;[POLL]: Is it reasonable to <em>unit</em> test express routes? Or is it better to do an <em>integration</em> test of your server (with supertest for ex.)?&lt;/p&gt;â€” Kent C. Dodds (@kentcdodds) &lt;a href=&quot;https://twitter.com/kentcdodds/status/794251165844185088&quot;&gt;November 3, 2016&lt;/a&gt;&lt;/blockquote&gt;
&lt;script async src=&quot;//platform.twitter.com/widgets.js&quot; charset=&quot;utf-8&quot;&gt;&lt;/script&gt;</p>
<p>I thought the poll posed an interesting question as to whether you should test Express routes or not. As I'm quite an evangelist of test driven development at the BBC, and I like a challenge and love writing code, I thought I'd have a think about it. I like to aim for as much test coverage as possible but I'm pragmatic enough to understand that 100% code coverage doesn't necessarily mean you're always testing the right things.</p>
<blockquote>
<p>&quot;Yes, you should unit test Express routes&quot;</p>
</blockquote>
<p>My answer to the poll was &quot;Yes, you should unit test Express routes&quot;, which I appreciate goes against the majority who said unit tests weren't reasonable. At the minimum, I think that you should <strong>definitely</strong> test Express routes with some solid integration testing. In our team, we use <a href="https://github.com/visionmedia/supertest">supertest</a> for our HTTP expectations and also <a href="https://github.com/node-nock/nock">nock</a> to mock responses from API calls and it works really well for testing full flows on Express routes. I'll be honest and say that we don't currently have full unit testing for the Express routes on the three main Node.js projects that our team work on, but having thought about it, I think there are some reasons why we probably should consider it.</p>
<h2>Reasons you should unit test Express routes</h2>
<h3>Better code coverage</h3>
<p>Firstly, it should give you better code coverage. Having 100% code coverage should never be the end goal of your testing efforts, but writing the best tests to assert your expectations of what your code should be doing is. I feel that aiming towards full coverage of your code means that you have complete confidence in it at the unit level, and you can reason that your modules should perform the functions you expect them to.</p>
<h3>Explicit expectations of middleware used</h3>
<p>Next, I think it helps that you're being explicit in the middleware you think you are calling for each route. It's always a good idea to split your middleware out into separate modules as this makes unit testing of each middleware much clearer by reading the test asserts and it makes writing the code much simpler. By subsequently adding tests for each route, you can also then assert that you're calling the right middleware. A good example of this would be to verify that you're adding your authentication layer to the expected routes. You want to know that you need to authenticate your user before they can see your administration, or per-user, routes and this is simple to do with an expectation that the authentication middleware is called on those specific routes.</p>
<h3>Security best practices</h3>
<p>Lastly, I've recently taken up the role as security champion of our team and have been working with <a href="http://blog.diniscruz.com/">Dinis Cruz</a>, a developer and application security expert, to ensure that our applications are more secure and adhere to <a href="https://www.owasp.org/index.php/Main_Page">OWASP</a> best practices. One of Dinis' suggestions is to write tests which assert the security expectations of your application. In this case, writing tests which assert that the specified routes apply your security middleware feel like an ideal use case for writing unit tests for Express routes in addition to your integration testing. In doing so it gives you much better confidence that you're writing secure code and that those specified routes are protected.</p>
<h2>How to write Express route unit tests</h2>
<p>So it's easy to say that we should unit test Express routes, but how do you do it in practice? As Kent said in his later tweets, there don't seem to be any good examples of how to do it so I've written a basic Express application and some corresponding tests in this <a href="https://github.com/MarcL/unit-test-express-routes">project on GitHub</a> which show you a good way to set these tests up. We'll be using <a href="https://mochajs.org/">mocha</a>, <a href="http://chaijs.com/">chai</a>, <a href="http://sinonjs.org">sinon</a>, <a href="https://github.com/domenic/sinon-chai">sinon-chai</a> (for some syntactic sugar) and <a href="https://github.com/thlorenz/proxyquire">proxyquire</a>.</p>
<p>Install the project as follows:</p>
<pre><code class="language-JavaScript">git clone git@github.com:MarcL/unit-test-express-routes.git
cd unit-test-express-routes
npm install
</code></pre>
<p>Now you should see a basic Express application in the <code>src/launch.js</code> module and the corresponding tests in the <code>test/launch.test.js</code> module. The application starts an Express server on port 7080 and exposes three example routes: <code>/</code>, <code>/login</code> and <code>/dashboard</code>. These are meant to mimic a homepage, a login page and a dashboard page which is only exposed after authentication.</p>
<pre><code class="language-javascript">import express from 'express';

import homepage from './middleware/homepage';
import login from './middleware/login';
import authenticate from './middleware/authenticate';
import dashboard from './middleware/dashboard';

function setupRoutes(app) {
    app.get('/', homepage);
    app.get('/login', login);
    app.get('/dashboard',
        authenticate,
        dashboard
    );
}

function start(port = 7080) {
    const app = express();

    setupRoutes(app);

    const server = app.listen(port, () =&gt; {
        console.log(`Server running on: ${port}`);
    });

    return server;
}

export {
    start
};
</code></pre>
<p>You can see from the code above, there are four example middlewares which have been split into their own modules. Splitting up your middleware like this is always a good idea as it allows you to separate the unit tests for the middeware from the route code. This makes the code much simpler and easy to read and allows you to write clean and understandable tests.</p>
<blockquote>
<p>Splitting up your middleware like this is always a good idea as it allows you to separate the unit tests for the middeware from the route code.</p>
</blockquote>
<p>We need to set up our tests so that we can stub the Express application that is created and then we can return a fake server that we can use in our test expectations. As each test needs this fake server to be initialised, I chose to do this using Mocha's <code>beforeEach</code> pre-condition block. As we don't need to return anything when we perform an <code>app.get</code> to set up our routes which respond to the GET request, we can use <code>sinon</code> spy. However, we want to return a fake HTTP server for the <code>app.listen</code> call, so we make this a <code>sinon</code> stub. We can then set up a fake Express server which is return via a <code>sinon</code> stub.</p>
<pre><code class="language-javascript">beforeEach(() =&gt; {
    // Initialise our spy and stub
    spyExpressGet = sinon.spy();
    stubExpressListen = sinon.stub();

    // Create fake express application with our spy and stub methods
    fakeExpress = {
        get: spyExpressGet,
        listen: stubExpressListen
    };

    // Return our fake express application when express() is called
    stubExpress = sinon.stub().returns(fakeExpress);

    ...
});
</code></pre>
<p>Next, we can set up a fake HTTP server which is what we'd expect <code>app.listen</code> to return. We do this so we can compare it in our test which checks that the app is listening as we expect.</p>
<pre><code class="language-javascript">// We never use the fake HTTP server but we want to compare it
const fakeHttpServer = {};

// app.listen returns a fake HttpServer
stubExpressListen.returns(fakeHttpServer);
</code></pre>
<p>It's easy to spy on each of the middlewares used for our routes by creating <code>sinon</code> spies. We don't need to test any of these middlewares here, so we don't need to use a stub. You should test each middleware separately from this route code.</p>
<pre><code class="language-javascript">spyHomepage = sinon.spy();
spyLogin = sinon.spy();
spyAuthenticate = sinon.spy();
spyDashboard = sinon.spy();
</code></pre>
<p>We now use <code>proxyquire</code> to override the module dependencies. This will allow us to inject our fake Express server and to spy on all of the middleware. All of these spies and stubs will be used in our test expectations. The <code>proxyquire</code> initialisation looks complex, but we're simply stubbing the call to <code>app.express</code> so that it returns our <code>stubExpress</code> and making sure that the calls to <code>import</code> or <code>require</code> the middleware modules in the real code will now be using our spies.</p>
<pre><code class="language-javascript">// Use proxyquire to stub required modules and return
// our spies so we can check assertions
server = proxyquire('../../src/launch', {
    express: stubExpress,
    './middleware/homepage' : {default: spyHomepage},
    './middleware/login': {default: spyLogin},
    './middleware/authenticate': {default: spyAuthenticate},
    './middleware/dashboard': {default: spyDashboard}
});
</code></pre>
<p>The hard part has now been done as we've set up our server before each test. We can now inspect the routes and make expectations on them  so let's take a look at our tests for that.</p>
<h2>Express route tests</h2>
<h3>Assertion that our server is listening</h3>
<p>First, we can write tests to check that our server is returning the expected HTTP server and runs on either the default port or a port we pass when initialising. We have stubbed <code>app.listen</code> to return a fake HTTP server so we can check that our call to <code>server.start()</code> returns it correctly. We can also confirm that it is called with either the default port of 7080, or another port that we pass through to the function call. The expectations are simple and readable so our fellow developers know exactly what the code should do. Note, for simplicity I'm using the general <code>sinon.match.func</code> matcher to match <em>any</em> function for the second parameter to <code>app.listen</code>.</p>
<pre><code class="language-javascript">    it('should return expected http server', () =&gt; {
        const returnedServer = server.start();
        expect(returnedServer).to.eql(fakeHttpServer);
    });

    it('should listen on default port 7080', () =&gt; {
        server.start();
        stubExpressListen.should.have.been.calledWithExactly(7080, sinon.match.func)
    });

    it('should listen on expected port if passed', () =&gt; {
        const expectedPort = 8888;
        server.start(expectedPort);
        stubExpressListen.should.have.been.calledWithExactly(expectedPort, sinon.match.func)
    });
</code></pre>
<p>We can then check each route using our <code>spyExpressGet</code> which spies on <code>app.get</code> for our routes. This is a simple case of confirming that each call sets the expected route string and the corresponding middleware(s).</p>
<pre><code class="language-javascript">it('should setup default route', () =&gt; {
    server.start();
    spyExpressGet.should.have.been.calledWithExactly('/', spyHomepage);
});

it('should setup login route', () =&gt; {
    server.start();
    spyExpressGet.should.have.been.calledWithExactly('/login', spyLogin);
});

it('should setup dashboard route', () =&gt; {
    server.start();
    spyExpressGet.should.have.been.calledWithExactly(
        '/dashboard',
        spyAuthenticate,
        spyDashboard
    );
});
</code></pre>
<p>We use sinon's <code>calledWithExactly</code>, albeit using the syntactic sugar of <code>sinon-chai</code>, to assert that we're setting the exact middleware for each route. This now gives us complete confidence that each route is only using the middleware that it should.</p>
<p>Notice that I've only stubbed the GET requests in my example project. If you wanted to validate the other routes which use other HTTP verbs then you should create a spy or stub for it and pass it into the fake Express application <code>fakeExpress</code>. You can then assert your expectations that <code>app.post</code>, <code>app.put</code> or <code>app.delete</code> are called with the expected route string and middleware.</p>
<h2>tl;dr</h2>
<p>Hopefully this was an easy-to-read explanation of how to create unit tests for Express routes. In case there is too much text to read above, my opinion is that, yes, I think you can easily unit test your Express routes and you probably should. You should do the following if you're planning to do so:</p>
<ul>
<li>Use <code>proxyquire</code> to override dependencies so that you can stub/spy your express application and middleware functions</li>
<li>Use <code>sinon</code> to stub your middleware, which you should have already extracted to their own modules</li>
<li>Use these stubs to assert your expectations that the Express application routes use the correct middleware</li>
<li>These tests are an additional layer of confidence and are especially useful for security concerns</li>
<li>You should <strong>always</strong> have additional integration tests which test the full flow of the routes</li>
</ul>
<p>If you've got any questions, need any clarification or have any comments on this then please <a href="/contact">contact me</a> or tweet at me.</p>


    </div>
  </section>
</main>


    <footer class="pv4 ph3 ph5-ns tc bg-light-gray bt b--moon-gray">
    <a href="/feed.xml" title="RSS feed" class="link dark-gray hover-silver dib h2 w2 mr3" aria-label="RSS feed icon">
        <span class="fa-stack fa-lg">
            <i class="fa fa-circle fa-stack-2x"></i>
            <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
        </span>
    </a>

    <a href="http://twitter.com/marclittlemore" target="_blank" rel="noreferrer" title="You should follow me on Twitter" class="link dark-gray hover-silver dib h2 w2 mr3" aria-label="Twitter icon">
        <span class="fa-stack fa-lg">
            <i class="fa fa-circle fa-stack-2x"></i>
            <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
        </span>
    </a>

    <a href="https://github.com/MarcL" target="_blank" rel="noreferrer" title="Follow me on GitHub" class="link dark-gray hover-silver dib h2 w2 mr3" aria-label="GitHub icon">
        <span class="fa-stack fa-lg">
            <i class="fa fa-circle fa-stack-2x"></i>
            <i class="fa fa-github fa-stack-1x fa-inverse"></i>
        </span>
    </a>

    <a href="https://www.instagram.com/marclittlemore" target="_blank" rel="noreferrer" title="Follow me on Instagram" class="link dark-gray hover-silver dib h2 w2 mr3" aria-label="Instagram icon">
        <span class="fa-stack fa-lg">
            <i class="fa fa-circle fa-stack-2x"></i>
            <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
        </span>
    </a>

    <a href="https://www.reddit.com/user/marclittlemore" target="_blank" rel="noreferrer" title="Upvote me on Reddit" class="link dark-gray hover-silver dib h2 w2 mr3" aria-label="Reddit icon">
        <span class="fa-stack fa-lg">
            <i class="fa fa-circle fa-stack-2x"></i>
            <i class="fa fa-reddit fa-stack-1x fa-inverse"></i>
        </span>
    </a>


  <div class="mt4 ttu">
    <a href="/javascript-testing" class="f6 fw5 link underline-hover near-black dib mr3 mr4-ns">JS Testing</a>
    <a href="/now" class="f6 fw5 link underline-hover near-black dib mr3 mr4-ns">Now</a>
    <a href="/uses" class="f6 fw5 link underline-hover near-black dib mr3 mr4-ns">Uses</a>
    <a href="/articles" class="f6 fw5 link underline-hover near-black dib mr3 mr4-ns">Articles</a>
    <a href="/contact" class="f6 fw5 link underline-hover near-black dib">Contact</a>
  </div>
  <div class="mt4 dark-gray f6 fw6 ttu">
      Copyright &copy; Marc Littlemore 
  </div>
</footer>

<script async defer data-pin-hover="true" data-pin-color="red" data-pin-tall="true" src="//assets.pinterest.com/js/pinit.js"></script>


</body>

</html>
