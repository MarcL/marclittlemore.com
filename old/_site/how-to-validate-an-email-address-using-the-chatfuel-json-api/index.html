<!DOCTYPE html>
<html lang="en" itemtype="http://schema.org/Article">

<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="When asking your chatbot user for an email address, how do you know if it's valid? Let's look at how you can validate an email address using the Chatfuel JSON API and a Node.js web server.">

    <title>How to validate an email adress using the Chatfuel JSON API - Marc Littlemore</title>

    <link rel="canonical" href="http://localhost:4000/how-to-validate-an-email-address-using-the-chatfuel-json-api/">

    <link rel="stylesheet" href="https://unpkg.com/tachyons@4.7.0/css/tachyons.min.css"/>

    <!-- Custom CSS -->
    
    
    

    <!-- Pygments Github CSS -->
    <link rel="stylesheet" href="/css/syntax.css">

    <!-- Custom Fonts -->
    <script src="https://kit.fontawesome.com/d38990851e.js" crossorigin="anonymous"></script>

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <link rel="apple-touch-icon" sizes="180x180" href="/images/favicons/apple-touch-icon.png">
<link rel="icon" type="image/png" href="/images/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/images/favicons/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/images/favicons/manifest.json">
<link rel="mask-icon" href="/images/favicons/safari-pinned-tab.svg" color="#5bbad5">
<meta name="theme-color" content="#ffffff">


    <meta name="p:domain_verify" content="7613bb2239e62b55de06dc926e1b6431"/>

    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-810717-3', 'auto');
  ga('send', 'pageview');
</script>
    








<!-- Open Graph -->
<meta property="og:site_name" content="Marc Littlemore" />
<meta property="og:url" content="http://localhost:4000/how-to-validate-an-email-address-using-the-chatfuel-json-api/" />
<meta property="og:title" content="How to validate an email adress using the Chatfuel JSON API" />
<meta property="og:description" content="When asking your chatbot user for an email address, how do you know if it's valid? Let's look at how you can validate an email address using the Chatfuel JSON API and a Node.js web server." />

<meta property="og:image" content="http://localhost:4000/images/social/how-to-validate-an-email-address-using-the-chatfuel-json-api.jpg" />
<meta property="og:type" content="article" />
<meta property="og:locale" content="en_GB" />
<meta property="article:published_time" content="2019-11-24" />
<meta property="article:author" content="https://www.facebook.com/marcdavidlittlemore" />

<!-- Schema.org markup for Google+ -->
<meta itemprop="name" content="How to validate an email adress using the Chatfuel JSON API">
<meta itemprop="description" content="When asking your chatbot user for an email address, how do you know if it's valid? Let's look at how you can validate an email address using the Chatfuel JSON API and a Node.js web server.">
<meta itemprop="image" content="http://localhost:4000/images/social/how-to-validate-an-email-address-using-the-chatfuel-json-api.jpg">

<!-- Twitter Card data -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@marclittlemore">
<meta name="twitter:title" content="How to validate an email adress using the Chatfuel JSON API">
<meta name="twitter:description" content="When asking your chatbot user for an email address, how do you know if it's valid? Let's look at how you can validate an email address using the Chatfuel JSON API and a Node.js web server.">
<meta name="twitter:creator" content="@marclittlemore">
<!-- Twitter summary card with large image must be at least 280x150px -->
<meta name="twitter:image:src" content="http://localhost:4000/images/social/how-to-validate-an-email-address-using-the-chatfuel-json-api.jpg">


    
    <script src="//load.sumome.com/" data-sumo-site-id="a260c264ca479174c95ace07722082ec75abbab6778c364ba7a24230cc55c451" async="async"></script>
    

    
        
    

    <!-- Facebook Pixel Code -->
<script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window,document,'script',
'https://connect.facebook.net/en_US/fbevents.js');
    fbq('init', '290377285027331'); 
fbq('track', 'PageView');
</script>
<noscript>
    <img height="1" width="1" 
src="https://www.facebook.com/tr?id=290377285027331&ev=PageView
&noscript=1"/>
</noscript>
<!-- End Facebook Pixel Code -->
</head>


<body class="avenir helvetica bg-white">

    <header class="white w-100 pt2 pb0 pb2-ns" style="z-index:100;">
    <nav class="fw6 ttu tracked tc">
        <div class="db" id="navLinks">
            
                
                    <a class="f7 f5-ns link dim black dib mr2 mr3-ns" href="/" title="marclittlemore.com">Home</a>
                
            
                
                    <a class="f7 f5-ns link dim black dib mr2 mr3-ns" href="/talks/" title="Ideas I've shared">Talks</a>
                
            
                
                    <a class="f7 f5-ns link dim black dib mr2 mr3-ns" href="/bots/" title="Learn how to create your own chatbot">Chatbots</a>
                
            
                
                    <a class="f7 f5-ns link dim black dib mr2 mr3-ns" href="/about/" title="Find out more about me">About</a>
                
            
        </div>
    </nav>
</header>


    <main id="main-content">
  <div class="mw8 center pt2 tc">
      <h1 class="f3 f1-ns black fw6 mt1 mb1 ph1 pv0">
        How to validate an email adress using the Chatfuel JSON API
      </h1>
      
        <h2 class="f3-ns f5 fw4 lh-copy gray mt1 mb2 ph1">When asking your chatbot user for an email address, how do you know if it's valid? Let's look at how you can validate an email address using the Chatfuel JSON API and a Node.js web server.</h2>
      
  </div>

  <div class="mw8 center pt2 tc">
    <img class="w-100 br2 shadow-4" src="/images/banners/gmail-interface.jpg" title="How to validate an email adress using the Chatfuel JSON API - When asking your chatbot user for an email address, how do you know if it's valid? Let's look at how you can validate an email address using the Chatfuel JSON API and a Node.js web server." alt="How to validate an email adress using the Chatfuel JSON API - When asking your chatbot user for an email address, how do you know if it's valid? Let's look at how you can validate an email address using the Chatfuel JSON API and a Node.js web server." />
  </div>

  <section class="mw8 pa3 mw8-ns ph5-ns center">
    <div class="roboto lh-copy f4-ns f5">
      <p>Facebook Messenger chatbots are a great addition to your marketing toolbox but they have one big problem.</p>

<p><em>Facebook controls the platform and can change its rules when it wants to.</em></p>

<p>Their <a href="https://developers.facebook.com/docs/messenger-platform/policy/policy-overview/#current_policy">recent changes to their broadcast and subscription messaging rules</a> means it’s more difficult to contact users after 24 hours if they’re not engaging with your bot. While stopping people from abusing Messenger messages is the right thing, how to you keep your user’s engaged?</p>

<p>I always recommend that you should consider Facebook Messenger as one of your marketing channels but you always need a multi-channel marketing approach. That’s why it’s useful to ask your chatbot users for their email address and add them to an email list in your Email Service Provider (ESP) like <a href="https://mailchimp.com/">Mailchimp</a> or <a href="https://convertkit.com/">ConvertKit</a>. Messenger allows you to ask for an email address using one of its quick replies but if the email isn’t available, or the user chooses to type it in, how do we make sure we’ve got valid data?</p>

<h2 id="validating-an-email-using-chatfuel">Validating an email using Chatfuel</h2>

<p>Let’s take a look at how we can validate a given user email using Chatfuel as our chatbot platform. Chatfuel allows you to ask for a user’s email using it’s “Save User Email” element. Adding this to your chatbot flow allows you to send a quick reply to your and ask for an email address which is then stored in a Chatfuel user attribute. If you pass this to your server side API using the JSON API plugin, you can’t validate it on the server to determine if it’s valid.</p>

<h2 id="watch-the-video">Watch The Video</h2>

<p>Take a look at how I build this email validation using <a href="https://glitch.com">Glitch</a> and a Node.js Express web server together with Chatfuel’s JSON API.</p>

<div class="aspect-ratio aspect-ratio--16x9 overflow-hidden mw-100">
    <iframe class="absolute top-0 left-0 w-100 h-100" src="https://www.youtube.com/embed/r4h4DD1DNE8" frameborder="0" allowfullscreen="">
    </iframe>
</div>

<h3 id="how-to-validate-an-email-address">How to validate an email address?</h3>

<h4 id="using-a-regular-expression">Using a regular expression</h4>

<p>Validating email addresses correctly can be tricky. One way is to use something called a <a href="https://en.wikipedia.org/wiki/Regular_expression">regular expression</a>. This is a sequence of characters that define a search pattern that you attempt to match against. You’ll find hundreds of different email regular expressions on the internet which give you various queries to validate against. However, they often come with caveats that they make a trade-off between speed and accuracy. You can use one of these to match the given email address with a specific pattern but you may incorrectly accept or reject some email addresses. The official regular expression which matches all email addresses is <a href="http://www.ex-parrot.com/~pdw/Mail-RFC822-Address.html">ridiculously big</a>. I can’t imagine attempting to debug this if it doesn’t work as expected in your programming language. While a regular expression will confirm if your email matches a specific pattern, we can’t confirm whether we can send an email to it.</p>

<h4 id="send-the-user-an-email">Send the user an email</h4>

<p>A nicer way is to determine if you can <a href="https://medium.com/hackernoon/the-100-correct-way-to-validate-email-addresses-7c4818f24643">send an email to the given email address</a>. This works really well for verifying an email address when signing up for an online service, but it’s not that easy when you need to validate an email in a chatbot flow. Flows in Messenger or WhatsApp can’t wait for your user to check their email and click on a link.</p>

<h4 id="checking-the-mx-record">Checking the MX record</h4>

<p>However, we can do something better by checking that the email has a valid domain to send email to. If we find a domain name in the given email address, we can check the DNS (Domain Name Server) records for the domain. These records can tell us the IP address on which the domain is hosted. They can also be used to see if email can be sent to the domain. For this we can check if the domain has an MX (Mail eXchange) record. If it does, we can send email to it.</p>

<h4 id="writing-an-api-service-to-check-for-a-valid-email-domain">Writing an API service to check for a valid email domain</h4>

<p>Checking for an MX record does take some time so first we can verify that the email address has the format of an email address. For this you can check for the presence of an @ symbol. If it exists then the user has at least attempted to give us something which is similar to an email address! If you retrieve the rest of the string after the @ symbol, this represents the domain name. In my video below, I use Node.js and the standard <a href="https://nodejs.org/docs/latest/api/dns.html">dns library</a> to determine if an MX record exists for that domain. If it does, then you should be able to send email to that address and we can consider it valid.</p>

<p>Here’s some example code to retrieve an email address and validate it.</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">dns</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'dns'</span><span class="p">);</span>

<span class="c1">// The dns library will return:</span>
<span class="c1">// ENOTFOUND - if no records exist at all for the domain</span>
<span class="c1">// ENODATA - if no MX record was found for the domain,</span>
<span class="c1">// or if the user data was invalid</span>
<span class="kd">const</span> <span class="nx">hasMxRecordError</span> <span class="o">=</span> <span class="nx">error</span> <span class="o">=&gt;</span> <span class="p">(</span>
    <span class="nx">error</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nx">error</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="s1">'ENOTFOUND'</span> <span class="o">||</span> <span class="nx">error</span><span class="p">.</span><span class="nx">code</span> <span class="o">===</span> <span class="s1">'ENODATA'</span><span class="p">)</span>
<span class="p">);</span>

<span class="c1">// A promise-based method to determine if the</span>
<span class="c1">// MX record exists for the given email</span>
<span class="kd">const</span> <span class="nx">checkValidMxRecord</span> <span class="o">=</span> <span class="nx">email</span> <span class="o">=&gt;</span> <span class="p">(</span>
    <span class="k">new</span> <span class="nb">Promise</span><span class="p">((</span><span class="nx">resolve</span><span class="p">,</span> <span class="nx">reject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// Determine if email is in the correct format</span>
        <span class="kd">const</span> <span class="nx">isEmail</span> <span class="o">=</span> <span class="nx">email</span><span class="p">.</span><span class="nx">includes</span><span class="p">(</span><span class="s1">'@'</span><span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">isEmail</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">reject</span><span class="p">(</span>
                <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'Invalid email address does not contain @ symbol'</span><span class="p">)</span>
            <span class="p">);</span>
        <span class="p">}</span>

        <span class="c1">// Split the email address and destructure to find the domain</span>
        <span class="c1">// TODO: You could also validate the username if you wanted to</span>
        <span class="kd">const</span> <span class="p">[</span><span class="nx">username</span><span class="p">,</span> <span class="nx">domain</span><span class="p">]</span> <span class="o">=</span> <span class="nx">email</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'@'</span><span class="p">);</span>

        <span class="c1">// Read the DNS records and see if an MX record exists for the domain</span>
        <span class="k">return</span> <span class="nx">dns</span><span class="p">.</span><span class="nx">resolveMx</span><span class="p">(</span><span class="nx">domain</span><span class="p">,</span> <span class="p">(</span><span class="nx">error</span><span class="p">,</span> <span class="nx">addresses</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="c1">// Check if any errors occurred</span>
            <span class="k">if</span> <span class="p">(</span><span class="nx">hasMxRecordError</span><span class="p">(</span><span class="nx">error</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nx">reject</span><span class="p">(</span><span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'Email has invalid MX record'</span><span class="p">));</span>
            <span class="p">}</span>
    
            <span class="c1">// You may not need the records but we can return them in case</span>
            <span class="k">return</span> <span class="nx">resolve</span><span class="p">(</span><span class="nx">addresses</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">}));</span>
</code></pre></div></div>

<p>To make my APIs more robust, I always return user attributes back to Chatfuel to inform it whether an API has succeeded or not. This allows us to avoid hard coding any messages in the API and gives back control to Chatfuel, or whichever chatbot platform you use, and use that to display the correct user messaging. It’s a good way to inform the user that they’ve potentially typed in their email incorrectly. You can also use this validation check to gate your content to only allow access to people who supply their email address.</p>

<p>Of course, this method has a flaw in that we can’t confirm that the username is valid without sending an email to it. We’ll find this out when we send an email to them from our mailing list but at least we got halfway there.</p>

<p>I hope you found this useful. All of the code is available on my <a href="https://glitch.com/~chatfuel-demo-bot">Chatfuel demo Glitch project</a>. Feel free to clone it and use it for your own APIs. If you spot any errors, or have any questions, then please <a href="/contact">send me a message</a>. I love to hear from people and I’m always happy to answer your questions.</p>

<div class="i fw5">
    <p>👉🏻 Want to learn more about JSON? Want to learn about the magic of JSON without being a developer? Get my <a href="/bots/sign-up-bot-building-for-beginners/" title="FREE JSON guide">FREE JSON guide</a> and you'll have JSON skills in no time!</p>
</div>



    </div>
  </section>
</main>


    <footer class="pv4 ph3 ph5-ns tc bg-light-gray bt b--moon-gray">
    <a href="/feed.xml" title="RSS feed" class="link dark-gray hover-silver dib h2 w2 mr3" aria-label="RSS feed icon">
        <span class="fa-stack fa-lg">
            <i class="fa fa-circle fa-stack-2x"></i>
            <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
        </span>
    </a>

    <a href="http://twitter.com/marclittlemore" target="_blank" rel="noreferrer" title="You should follow me on Twitter" class="link dark-gray hover-silver dib h2 w2 mr3" aria-label="Twitter icon">
        <span class="fa-stack fa-lg">
            <i class="fa fa-circle fa-stack-2x"></i>
            <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
        </span>
    </a>

    <a href="https://github.com/MarcL" target="_blank" rel="noreferrer" title="Follow me on GitHub" class="link dark-gray hover-silver dib h2 w2 mr3" aria-label="GitHub icon">
        <span class="fa-stack fa-lg">
            <i class="fa fa-circle fa-stack-2x"></i>
            <i class="fa fa-github fa-stack-1x fa-inverse"></i>
        </span>
    </a>

    <a href="https://www.instagram.com/marclittlemore" target="_blank" rel="noreferrer" title="Follow me on Instagram" class="link dark-gray hover-silver dib h2 w2 mr3" aria-label="Instagram icon">
        <span class="fa-stack fa-lg">
            <i class="fa fa-circle fa-stack-2x"></i>
            <i class="fa fa-instagram fa-stack-1x fa-inverse"></i>
        </span>
    </a>

    <a href="https://www.reddit.com/user/marclittlemore" target="_blank" rel="noreferrer" title="Upvote me on Reddit" class="link dark-gray hover-silver dib h2 w2 mr3" aria-label="Reddit icon">
        <span class="fa-stack fa-lg">
            <i class="fa fa-circle fa-stack-2x"></i>
            <i class="fa fa-reddit fa-stack-1x fa-inverse"></i>
        </span>
    </a>


  <div class="mt4 ttu">
    <a href="/javascript-testing" class="f6 fw5 link underline-hover near-black dib mr3 mr4-ns">JS Testing</a>
    <a href="/now" class="f6 fw5 link underline-hover near-black dib mr3 mr4-ns">Now</a>
    <a href="/uses" class="f6 fw5 link underline-hover near-black dib mr3 mr4-ns">Uses</a>
    <a href="/articles" class="f6 fw5 link underline-hover near-black dib mr3 mr4-ns">Articles</a>
    <a href="/contact" class="f6 fw5 link underline-hover near-black dib">Contact</a>
  </div>
  <div class="mt4 dark-gray f6 fw6 ttu">
      Copyright &copy; Marc Littlemore 2020
  </div>
</footer>

<script async defer data-pin-hover="true" data-pin-color="red" data-pin-tall="true" src="//assets.pinterest.com/js/pinit.js"></script>


</body>

</html>
